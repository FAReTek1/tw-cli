<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Run sb3</title>

    <style>
        #project {
            width: 480px;
            height: 360px;
        }
    </style>

</head>
<body>
<script src="scaffolding-with-music.js"></script>
<div id="project"></div>

<script>
    function delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    // Then scaffolding is exported as a global variable
    const scaffolding = new Scaffolding.Scaffolding();

    scaffolding.width = 480;
    scaffolding.height = 360;
    scaffolding.resizeMode = 'preserve-ratio'; // or 'dynamic-resize' or 'stretch'
    scaffolding.editableLists = false;
    scaffolding.shouldConnectPeripherals = true;
    scaffolding.usePackagedRuntime = false;

    scaffolding.setup();
    const elem = document.getElementById('project');
    console.log(elem);
    scaffolding.appendTo(elem);


    // await scaffolding.loadProject();
    const data = new URLSearchParams(window.location.search).get("project");
    let bindata = atob(data.replace(/_/g, '/').replace(/-/g, '+'));
    bindata = Uint8Array.from(bindata, c => c.charCodeAt(0));
    const output = [];
    let get_tw_cli_var;

    const timeout = new URLSearchParams(window.location.search).get("timeout");

    (async () => {
        await scaffolding.loadProject(bindata);
        console.log("RUNTIME: Project loaded.");

        const vm = scaffolding.vm;
        const runtime = vm.runtime;
        let done = false;
        /**
         * @param name {string}
         * @param _default {string}
         * @return {string}
         */
        get_tw_cli_var = (name, _default = undefined) => {
            name = `TW-CLI: ${name}`;
            const vars = runtime._stageTarget.variables;

            for (let k in vars) {
                let v = vars[k];
                console.log(`${v.name} = ${v.value}`);
                if (v.name === name) {
                    console.log(`Found: ${v.value}`);
                    return v.value;
                }
            }

            console.log(`default: ${_default}`);

            return _default.toString();  // we must always output a string.
        }

        const exit = (__override = undefined) => {
            if (done) {
                // If we already started the exit process, don't start queueing another
                return;
            }

            done = true;
            let exitCode;
            if (__override !== undefined) {
                exitCode = __override;
            } else {
                exitCode = get_tw_cli_var("exit code", 0).toString();
            }
            output.push({
                type: "exit_code",
                content: exitCode,
            })
            window.alert(`RUNTIME: PROJECT DONE`);
        }

        // following code is from goboscript.ide by aspizu
        vm.addAddonBlock({
            procedureCode: "\u200B\u200Blog\u200B\u200B %s",
            arguments: ["content"],
            callback: ({content}, util) => {
                output.push({
                    type: "log",
                    content: content,
                    // util: util,
                })
            }
        })
        vm.addAddonBlock({
            procedureCode: "\u200B\u200Bwarn\u200B\u200B %s",
            arguments: ["content"],
            callback: ({content}, util) => {
                output.push({
                    type: "warn",
                    content: content,
                    // util: util,
                })
            }
        })
        vm.addAddonBlock({
            procedureCode: "\u200B\u200Berror\u200B\u200B %s",
            arguments: ["content"],
            callback: ({content}, util) => {
                output.push({
                    type: "error",
                    content: content,
                    // util: util,
                })
            }
        })
        vm.addAddonBlock({
            procedureCode: "\u200B\u200Bbreakpoint\u200B\u200B",
            arguments: [],
            callback: ({}, util) => {
                output.push({
                    type: "breakpoint",
                    // util: util,
                })
                exit('1');
            }
        })
        vm.addAddonBlock({
            procedureCode: "\u200B\u200Bexit\u200B\u200B %s",
            arguments: ["content"],
            callback: ({content}, util) => {
                exit(content.toString());
            }
        })
        runtime.addListener('QUESTION', () => {
            console.log(`question asked`);
        });

        runtime.addListener('SAY', (target, type, msg) => {
            if (msg !== '') {
                console.log(`say: ${type} - ${msg}`);
                output.push({
                    type: type,
                    content: msg
                })
            }
        });

        runtime.addListener('PROJECT_RUN_STOP', (question) => {
            exit("PROJECT_RUN_STOP");
        });

        const logOnEvent = (type) => {
            runtime.addListener(type, () => {
                console.log(`RUNTIME EVENT: ${type}`);
            });
        }

        // once the project is started and is ready to run, it should run
        // it wont if it's empty (i think)
        // add a time check, starting on PROJECT_START,
        // and checking if PROJECT_RUN_START occurs within `timeout` milliseconds
        runtime.addListener('PROJECT_START', async () => {
            const time = Date.now();
            console.log(`PROJECT_START: ${time}; WAITING FOR ${timeout}ms`);

            let project_run_started = false;
            runtime.addListener('PROJECT_RUN_START', () => {
                project_run_started = true;
            });

            await delay(timeout);
            if ((Date.now() - project_run_started) > timeout) {
                console.log(`CHECKING PROJECT RUN STATUS: ${project_run_started}; T=${Date.now()}`)

                if (!project_run_started) {
                    output.push({
                        type: "did_not_run",
                        content: `Project failed to run within ${timeout} ms. Is it empty?`,
                    })
                    exit('', "1")
                }
            }
        });

        logOnEvent("PROJECT_START");
        logOnEvent("PROJECT_RUN_START");
        logOnEvent("VISUAL_REPORT");
        logOnEvent("RUNTIME_STARTED");
        logOnEvent("RUNTIME_DISPOSED");

        console.log("RUNTIME: PROJECT READY");
        scaffolding.greenFlag();
    })();

</script>
</body>
</html>
